plugins {
    id("com.android.library")
    id("kotlin-android")
    id("kotlin-kapt")
    id("kotlinx-serialization")
}

android {
    compileSdkVersion ProjectVersions.androidSdk

    defaultConfig {
        minSdkVersion ProjectVersions.minSdk
        targetSdkVersion ProjectVersions.androidSdk
        versionCode 1
        versionName version
            testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
            testCoverageEnabled false
        }
        debug {
            testCoverageEnabled true
        }
    }

    sourceSets {
        androidTest {
            assets.srcDirs += ["../../../packages/test-www/dist", "../../../packages/nimbus-bridge/dist/iife"]
        }
    }

    testOptions {
        unitTests.returnDefaultValues = true
    }

}

dependencies {
//    androidTestImplementation(nimbusModule("annotations"))
//    androidTestImplementation(Libs.k2v8)
//    androidTestImplementation(nimbusModule("bridge-v8"))
//    androidTestImplementation(nimbusModule("bridge-webview"))
//    androidTestImplementation(Libs.j2v8)
//    androidTestImplementation(Libs.guava)
//    kaptAndroidTest(nimbusModule("compiler-webview"))
//    kaptAndroidTest(nimbusModule("compiler-v8"))
    androidTestImplementation project(":modules:annotations")
    androidTestImplementation(Libs.k2v8)
    androidTestImplementation project(":modules:bridge-v8")
    androidTestImplementation project(":modules:bridge-webview")
    androidTestImplementation(Libs.j2v8)
    androidTestImplementation(Libs.guava)
    kaptAndroidTest project(":modules:compiler-webview")
    kaptAndroidTest project(":modules:compiler-v8")

    androidTestImplementation(Libs.kotlinx_serialization_runtime)
    androidTestImplementation(Libs.junit)
    androidTestImplementation(Libs.espresso_core)
    androidTestImplementation(Libs.androidx_test_rules, {
        exclude group: "com.android.support", module: "support-annotations"
    })
    androidTestImplementation(Libs.truth)
    androidTestImplementation(Libs.kotlintest_runner_junit4)
}

/*
 * Compile the test web app prior to assembling the androidTest app
 */
task buildTestWebApp(type: Exec) {
    workingDir "../../.."
    commandLine "npm", "install"
}

tasks.whenTaskAdded { task ->
    if (task.name ==~ "assemble.*AndroidTest") {
    task.dependsOn buildTestWebApp
}
}

apply from: rootProject.file("gradle/lint.gradle")
